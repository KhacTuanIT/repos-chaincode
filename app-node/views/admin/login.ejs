<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>

    <link rel="icon" href="/img/brand/favicon.png" type="image/png">
    <!-- Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700">
    <!-- Icons -->
    <link rel="stylesheet" href="/vendor/nucleo/css/nucleo.css" type="text/css">
    <link rel="stylesheet" href="/vendor/@fortawesome/fontawesome-free/css/all.min.css" type="text/css">
    <!-- Argon CSS -->
    <link rel="stylesheet" href="/css/argon.css" type="text/css">
</head>

<body class="bg-default">
    <!-- Navbar -->
    <!-- Main content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header bg-gradient-secondary py-7 py-lg-8 pt-lg-9">
            <div class="container">
                <div class="header-body text-center mb-7">
                    <div class="row justify-content-center">
                        <div class="col-xl-5 col-lg-6 col-md-8 px-5 alert-primary">
                            <h1 class="text-white">Welcome!</h1>
                            <p class="text-lead text-white">Welcome to TECO Content Management System.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="separator separator-bottom separator-skew zindex-100">
                <svg x="0" y="0" viewBox="0 0 2560 100" preserveAspectRatio="none" version="1.1"
                    xmlns="http://www.w3.org/2000/svg">
                    <polygon class="fill-default" points="2560 0 2560 100 0 100"></polygon>
                </svg>
            </div>
        </div>
        <!-- Page content -->
        <div class="container mt--8 pb-5">
            <div class="row justify-content-center">
                <div class="col-lg-5 col-md-7">
                    <div class="card bg-secondary border-0 mb-0">
                        <div class="card-header bg-transparent pb-5">
                            <div class="text-muted text-center mt-2 mb-3"><small>Sign in with</small></div>
                            <div class="btn-wrapper text-center">
                                <a href="#" class="btn btn-neutral btn-icon">
                                    <span class="btn-inner--icon"><img src="/img/icons/common/github.svg"></span>
                                    <span class="btn-inner--text">Github</span>
                                </a>
                                <a href="#" class="btn btn-neutral btn-icon">
                                    <span class="btn-inner--icon"><img src="/img/icons/common/google.svg"></span>
                                    <span class="btn-inner--text">Google</span>
                                </a>
                            </div>
                        </div>
                        <div class="card-body px-lg-5 py-lg-2">
                            <div class="text-center text-muted mb-4">
                                <small>Or sign in with credentials</small>
                            </div>
                            <form role="form">
                                <input class="form-control" id="org" value="supply" type="hidden">
                                <div class="form-group mb-1">
                                    <div class="input-group input-group-merge input-group-alternative">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="ni ni-email-83"></i></span>
                                        </div>
                                        <input class="form-control" id="username" placeholder="Username" type="text">
                                    </div>
                                    <span id="invalid-username" class="invalid-text-value text-danger"></span>
                                </div>
                                <div class="form-group mb-1">
                                    <div class="input-group input-group-merge input-group-alternative">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="ni ni-lock-circle-open"></i></span>
                                        </div>
                                        <input class="form-control" id="password" placeholder="Password"
                                            type="password">
                                    </div>
                                    <span id="invalid-password" class="invalid-text-value text-danger"></span>
                                </div>
                                <div class="form-group">
                                    <div class="input-group input-group-merge input-group-alternative">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="ni ni-paper-diploma"></i></span>
                                        </div>
                                        <input class="form-control" id="key" placeholder="Credentials file" type="file">
                                    </div>
                                    <span id="invalid-key" class="invalid-text-value text-danger"></span>
                                </div>
                                <div class="custom-control custom-control-alternative custom-checkbox">
                                    <input class="custom-control-input" id=" customCheckLogin" type="checkbox">
                                    <label class="custom-control-label" for=" customCheckLogin">
                                        <span class="text-muted">Remember me</span>
                                    </label>
                                </div>
                                <div class="text-center">
                                    <button type="button" id="btn-login" class="btn btn-primary my-4">
                                        <div id="loader-register" class="lds-ring hidden">
                                            <div></div>
                                            <div></div>
                                            <div></div>
                                            <div></div>
                                        </div>
                                        Sign in
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-6">
                            <a href="#" class="text-light"><small>Forgot password?</small></a>
                        </div>
                        <div class="col-6 text-right">
                            <a href="#" class="text-light"><small>Create new account</small></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer -->
    <footer class="py-5" id="footer-main">
        <div class="container">
            <div class="row align-items-center justify-content-xl-between">
                <div class="col-xl-6">
                    <div class="copyright text-center text-xl-left text-muted">
                        &copy; 2021 <a href="https://www.creative-tim.com" class="font-weight-bold ml-1"
                            target="_blank">Creative Tim</a>
                    </div>
                </div>
                <div class="col-xl-6">
                    <ul class="nav nav-footer justify-content-center justify-content-xl-end">
                        <li class="nav-item">
                            <a href="https://www.creative-tim.com" class="nav-link" target="_blank">Creative Tim</a>
                        </li>
                        <li class="nav-item">
                            <a href="https://www.creative-tim.com/presentation" class="nav-link" target="_blank">About
                                Us</a>
                        </li>
                        <li class="nav-item">
                            <a href="http://blog.creative-tim.com" class="nav-link" target="_blank">Blog</a>
                        </li>
                        <li class="nav-item">
                            <a href="https://github.com/creativetimofficial/argon-dashboard/blob/master/LICENSE.md"
                                class="nav-link" target="_blank">MIT License</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
    <!-- Argon Scripts -->
    <!-- Core -->
    <script src="/vendor/jquery/dist/jquery.min.js"></script>
    <script src="/vendor/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/vendor/js-cookie/js.cookie.js"></script>
    <script src="/vendor/jquery.scrollbar/jquery.scrollbar.min.js"></script>
    <script src="/vendor/jquery-scroll-lock/dist/jquery-scrollLock.min.js"></script>
    <!-- Argon JS -->
    <script src="/js/argon.js"></script>
    <script>
        function getFileName(fullPath) {

            if (fullPath) {
                var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
                var filename = fullPath.substring(startIndex);
                if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
                    filename = filename.substring(1);
                }
                return filename;
            }
            return null;
        }

        function clearAfterDelay(e) {
            setTimeout(() => {
                e.text("");
            }, 10000);
        }
        $(document).on("click", "#btn-login", function () {
            let _this = $(this);
            _this.attr("disabled", "disabled");
            let spin = $("#btn-login > div");
            if (spin) {
                if (spin.hasClass("hidden")) {
                    spin.removeClass("hidden");
                }
            }
            // var form = document.forms.namedItem('flogin');
            let data = new FormData();
            data.append("key", $('#key').prop("files")[0]);
            var fullPath = document.getElementById('key').value;
            console.log(fullPath);
            const filename = getFileName(fullPath);
            console.log(filename);
            var formLogin = {
                org: $('#org').val(),
                username: $('#username').val(),
                password: $('#password').val(),
                fileid: filename
            };
            $.ajax({
                url: "/upload-keys",
                type: "post",
                data: data,
                processData: false,
                contentType: false,
                success: function (res) {
                    $.ajax({
                        url: "/admin/login",
                        type: "post",
                        data: formLogin,
                        success: function (res) {
                            if (res.status) {
                                if (window.location.pathname.includes("login")) {
                                    window.location.href = "/admin";
                                } else {
                                    window.location.href = window.location.href;
                                }
                            } else {
                                toastr.danger(
                                    res.message ? res.message : "Server is updating now..."
                                );
                            }
                        },
                        error: function (jq, status, err) {
                            _this.removeAttr("disabled");
                            if (spin) {
                                if (!spin.hasClass("hidden")) {
                                    spin.addClass("hidden");
                                }
                            }
                            let responseError = JSON.parse(jq.responseText);
                            console.log(responseError);
                            responseError.errors.forEach((error) => {
                                if (!$("#" + error.param).hasClass("invalid-error-input")) {
                                    $("#" + error.param).addClass("invalid-error-input");
                                    setTimeout(() => {
                                        if ($("#" + error.param).hasClass("invalid-error-input")) {
                                            $("#" + error.param).removeClass("invalid-error-input");
                                        }
                                    }, 5000);
                                }
                                $("#invalid-" + error.param).text(error.msg);
                                clearAfterDelay($("#invalid-" + error.param));
                            });
                        },
                    });
                },
                error: function (jq, status, error) {
                    _this.removeAttr("disabled");
                    if (spin) {
                        if (!spin.hasClass("hidden")) {
                            spin.addClass("hidden");
                        }
                    }
                    let responseError = JSON.parse(jq.responseText);
                    console.log(responseError);
                    responseError.errors.forEach((error) => {
                        if (!$("#" + error.param).hasClass("invalid-error-input")) {
                            $("#" + error.param).addClass("invalid-error-input");
                            setTimeout(() => {
                                if ($("#" + error.param).hasClass("invalid-error-input")) {
                                    $("#" + error.param).removeClass("invalid-error-input");
                                }
                            }, 5000);
                        }
                        $("#invalid-" + error.param).text(error.msg);
                        clearAfterDelay($("#invalid-" + error.param));
                    });
                },
            });
        });
    </script>
</body>

</html>